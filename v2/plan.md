# TRPC 待实现功能清单

本文档列出了将 TRPC 从最小化原型发展为生产级 RPC 框架所需的改进功能，按优先级排序。

## P0 - 必须实现（生产环境基础）

### 1. 消息分帧机制
**问题**：当前没有长度前缀，无法正确处理 TCP 粘包/半包问题。

**实现方案**：
- 添加消息头（4字节长度 + 可选元数据）
- 支持读取完整消息，避免部分读取
- 支持大消息（移除 1024 字节固定缓冲区限制）

**影响文件**：
- `trpc/entity.go` - 新增 Message 结构
- `trpc/server.go:63-85` - `recv()` 方法改进
- `trpc/client.go:53-60` - `Invoke()` 方法改进

**估算工作量**：2-3 小时

---

### 2. 超时机制
**问题**：所有网络操作没有超时，可能导致永久阻塞。

**实现方案**：
- Dial 超时
- Read/Write 超时
- 方法调用总超时
- 使用 `context.WithTimeout` 传播超时

**影响文件**：
- `trpc/client.go:24,35-61` - 所有网络操作
- `trpc/server.go:28,49,63` - 所有网络操作

**估算工作量**：2 小时

---

### 3. 连接复用（连接池）
**问题**：每次调用都创建新连接，性能开销大。

**实现方案**：
- 客户端实现连接池
- 支持连接复用
- 连接保活机制
- 最大连接数限制

**影响文件**：
- `trpc/client.go` - 重构为连接池管理
- 新增 `trpc/pool.go` - 连接池实现

**估算工作量**：4-6 小时

---

### 4. 错误处理完善
**问题**：多处忽略序列化/反序列化错误。

**实现方案**：
- 所有 `json.Marshal/Unmarshal` 错误必须处理
- 所有网络错误必须处理
- 统一错误码定义
- 详细错误日志

**影响文件**：
- `trpc/server.go:82,114` - 错误处理
- `trpc/client.go:60` - 错误处理

**估算工作量**：1 小时

---

### 5. Context 传播
**问题**：服务端硬编码 `context.Background()`，无法取消请求。

**实现方案**：
- 协议中传递 Context 元数据
- 服务端使用客户端传递的 Context
- 支持取消信号传播

**影响文件**：
- `trpc/entity.go` - 添加 Context 元数据字段
- `trpc/server.go:104` - 使用传入的 Context
- `trpc/client.go` - 传递 Context

**估算工作量**：2-3 小时

---

## P1 - 重要功能（可用性增强）

### 6. 拦截器机制
**价值**：可扩展出日志、监控、认证、限流等功能。

**实现方案**：
- 定义 `Interceptor` 接口
- 服务端拦截器链
- 客户端拦截器链
- 常用拦截器实现（日志、恢复）

**影响文件**：
- 新增 `trpc/interceptor.go`
- `trpc/server.go` - 支持拦截器
- `trpc/client.go` - 支持拦截器

**估算工作量**：6-8 小时

---

### 7. 重试机制
**价值**：提高服务可用性。

**实现方案**：
- 可配置重试策略（指数退避）
- 重试次数限制
- 可重试错误判断
- 客户端集成重试逻辑

**影响文件**：
- 新增 `trpc/retry.go`
- `trpc/client.go` - 集成重试

**估算工作量**：4 小时

---

### 8. 优雅关闭
**价值**：服务安全关闭，避免请求丢失。

**实现方案**：
- 捕获信号（SIGTERM/SIGINT）
- 停止接受新连接
- 等待现有请求完成
- 超时强制关闭

**影响文件**：
- `trpc/server.go` - 新增 `Shutdown()` 方法

**估算工作量**：3 小时

---

### 9. 健康检查
**价值**：监控服务状态，便于负载均衡。

**实现方案**：
- 内置健康检查端点
- 自定义健康检查逻辑
- HTTP 接口或 RPC 接口

**影响文件**：
- 新增 `trpc/health.go`

**估算工作量**：2 小时

---

### 10. 流式通信
**价值**：支持大文件传输、实时数据推送等场景。

**实现方案**：
- 单向流（Server-Stream）
- 双向流（Bi-Directional Stream）
- 流式协议设计

**影响文件**：
- 新增 `trpc/stream.go`
- 协议升级

**估算工作量**：10-15 小时

---

## P2 - 增强功能（生产级特性）

### 11. 负载均衡
**价值**：多实例支持，提高系统容量。

**实现方案**：
- 多种策略（轮询、随机、加权）
- 客户端负载均衡
- 服务端负载均衡支持

**影响文件**：
- 新增 `trpc/balancer.go`

**估算工作量**：6-8 小时

---

### 12. 服务发现
**价值**：动态服务注册和发现，支持动态扩缩容。

**实现方案**：
- 接入 etcd/consul/nacos
- 服务注册
- 服务发现
- 健康检查集成

**影响文件**：
- 新增 `trpc/discovery.go`

**估算工作量**：8-10 小时

---

### 13. 监控指标
**价值**：可观测性，便于问题排查和性能优化。

**实现方案**：
- 请求计数
- 延迟分布
- 错误率
- 集成 Prometheus/metrics

**影响文件**：
- 新增 `trpc/metrics.go`

**估算工作量**：4-6 小时

---

### 14. 结构化日志
**价值**：便于日志分析和追踪。

**实现方案**：
- 使用标准日志库（zap/logrus）
- 请求追踪 ID
- 日志级别控制

**影响文件**：
- 所有日志输出

**估算工作量**：2-3 小时

---

### 15. TLS 支持
**价值**：通信加密，保证安全性。

**实现方案**：
- 支持 TLS 配置
- 服务端 TLS 证书
- 客户端 TLS 验证

**影响文件**：
- `trpc/server.go` - TLS 支持
- `trpc/client.go` - TLS 支持

**估算工作量**：3-4 小时

---

### 16. 认证机制
**价值**：控制访问权限。

**实现方案**：
- Token 认证
- API Key 认证
- 拦截器集成

**影响文件**：
- 新增 `trpc/auth.go`
- 拦截器集成

**估算工作量**：4-6 小时

---

### 17. 代码生成工具
**价值**：类型安全，提高开发效率。

**实现方案**：
- IDL 定义（类似 protobuf）
- 代码生成器
- 自动生成 Client 和 Server 存根

**影响文件**：
- 新增 `cmd/gen/` - 代码生成工具

**估算工作量**：15-20 小时

---

### 18. 压缩支持
**价值**：减少网络传输量。

**实现方案**：
- 支持 gzip/snappy
- 可配置压缩策略
- 拦截器集成

**影响文件**：
- 新增 `trpc/compress.go`

**估算工作量**：3 小时

---

### 19. Protobuf 支持
**价值**：高性能序列化，兼容 gRPC。

**实现方案**：
- 插拔式序列化器
- Protobuf 编解码器
- 保持 JSON 后向兼容

**影响文件**：
- 新增 `trpc/codec/`
- 重构序列化逻辑

**估算工作量**：6-8 小时

---

### 20. 心跳机制
**价值**：检测连接存活，及时发现失效连接。

**实现方案**：
- 客户端心跳
- 服务端心跳响应
- 心跳超时处理

**影响文件**：
- `trpc/client.go`
- `trpc/server.go`

**估算工作量**：3-4 小时

---

## 实现路线建议

### 第一阶段：核心修复（P0）
目标：解决阻塞性问题，达到基本可用

- 消息分帧
- 超时机制
- 错误处理
- Context 传播

**预计时间**：8-12 小时

### 第二阶段：可用性增强（P0+P1）
目标：支持小规模实际使用

- 连接复用
- 拦截器机制
- 重试机制
- 优雅关闭
- 健康检查

**预计时间**：20-30 小时

### 第三阶段：生产级特性（P2）
目标：可用于生产环境

- 监控指标
- 结构化日志
- TLS/认证
- 服务发现
- 负载均衡

**预计时间**：30-40 小时

### 第四阶段：高级功能
目标：功能完善，生态丰富

- 流式通信
- 代码生成工具
- Protobuf 支持
- 压缩支持

**预计时间**：35-45 小时

---

## 总计工作量

- **P0（必须）**：11-17 小时
- **P1（重要）**：27-32 小时
- **P2（增强）**：46-57 小时
- **总计**：84-106 小时（约 2-3 周全职开发）

---

## 备注

- 当前实现适合学习 RPC 基本原理
- 建议按优先级逐步实现
- 每个功能实现后应补充单元测试
- 参考成熟框架：gRPC、Dubbo、brpc 等
